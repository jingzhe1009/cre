<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bonc.frame.dao.rule.RuleDetailMapper">
    <resultMap id="RuleDetailHeaderMap" type="com.bonc.frame.entity.rule.RuleDetailHeader">
        <result column="RULE_NAME" property="ruleName" jdbcType="VARCHAR"/>
        <result column="FOLDER_ID" property="folderId" jdbcType="VARCHAR"/>
        <result column="RULE_DESC" property="ruleDesc" jdbcType="VARCHAR"/>
        <result column="RULE_TYPE" property="ruleType" jdbcType="VARCHAR"/>
        <result column="IS_PUBLIC" property="isPublic" jdbcType="VARCHAR"/>
        <result column="MODEL_GROUP_ID" property="modelGroupId" jdbcType="VARCHAR"/>
        <result column="MODEL_GROUP_NAME" property="modelGroupName" jdbcType="VARCHAR"/>
        <result column="MODULE_NAME" property="moduleName" jdbcType="VARCHAR"/>
        <result column="CREATE_PERSON" property="createPerson" jdbcType="VARCHAR"/>
        <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_PERSON" property="updatePerson" jdbcType="VARCHAR"/>
        <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP"/>
        <result column="DEPT_ID" property="deptId" jdbcType="VARCHAR"/>
        <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR"/>
        <result column="PARTNER_CODE" property="partnerCode" jdbcType="VARCHAR"/>
        <result column="PARTNER_NAME" property="partnerName" jdbcType="VARCHAR"/>
        <result column="PRODUCT_CODE" property="productCode" jdbcType="VARCHAR"/>
        <result column="PRODUCT_NAME" property="productName" jdbcType="VARCHAR"/>
        <result column="SYSTEM_CODE" property="systemCode" jdbcType="VARCHAR"/>
        <result column="SYSTEM_NAME" property="systemName" jdbcType="VARCHAR"/>
        <result column="CREATE_USER_JOB_NUMBER" property="platformCreateUserJobNumber" jdbcType="VARCHAR"/>
        <result column="UPDATE_USER_JOB_NUMBER" property="platformUpdateUserJobNumber" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="BaseResultMap" type="com.bonc.frame.entity.rule.RuleDetail"
               extends="RuleDetailHeaderMap">
        <id column="RULE_ID" property="ruleId" jdbcType="VARCHAR"/>
        <result column="IS_DEL" property="isDel" jdbcType="VARCHAR"/>
        <result column="IS_LOG" property="isLog" jdbcType="VARCHAR"/>
        <result column="RULE_STATUS" property="ruleStatus" jdbcType="VARCHAR"/>
        <result column="VERSION" property="version" jdbcType="VARCHAR"/>
        <result column="VERSION_DESC" property="versionDesc" jdbcType="VARCHAR"/>
        <result column="VERSION_CREATE_PERSON" property="versionCreatePerson" jdbcType="VARCHAR"/>
        <result column="VERSION_CREATE_DATE" property="versionCreateDate" jdbcType="TIMESTAMP"/>
        <result column="VERSION_UPDATE_PERSON" property="versionUpdatePerson" jdbcType="VARCHAR"/>
        <result column="VERSION_UPDATE_DATE" property="versionUpdateDate" jdbcType="TIMESTAMP"/>
        <result column="DEPT_ID" property="deptId" jdbcType="VARCHAR"/>
        <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR"/>
        <result column="PARTNER_CODE" property="partnerCode" jdbcType="VARCHAR"/>
        <result column="PARTNER_NAME" property="partnerName" jdbcType="VARCHAR"/>
        <result column="PRODUCT_CODE" property="productCode" jdbcType="VARCHAR"/>
        <result column="PRODUCT_NAME" property="productName" jdbcType="VARCHAR"/>
        <result column="SYSTEM_CODE" property="systemCode" jdbcType="VARCHAR"/>
        <result column="SYSTEM_NAME" property="systemName" jdbcType="VARCHAR"/>
        <result column="CREATE_USER_JOB_NUMBER" property="platformCreateUserJobNumber" jdbcType="VARCHAR"/>
        <result column="UPDATE_USER_JOB_NUMBER" property="platformUpdateUserJobNumber" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="ResultMapWithBLOBs" type="com.bonc.frame.entity.rule.RuleDetailWithBLOBs" extends="BaseResultMap">
        <result column="RULE_CONTENT" property="ruleContent" jdbcType="CLOB"/>
        <result column="RULE_INTERCEPT" property="ruleIntercept" jdbcType="CLOB"/>
    </resultMap>

    <resultMap id="getModelByRuleSetIdList" type="com.bonc.frame.entity.rule.RuleSetWithModel">
        <result column="RULE_ID"  property="ruleId" jdbcType="VARCHAR"/>
        <result column="RULE_TYPE"  property="ruleType" jdbcType="VARCHAR"/>
        <result column="RULE_NAME"  property="ruleName" jdbcType="VARCHAR"/>
        <result column="VERSION"  property="version" jdbcType="VARCHAR"/>
        <result column="MODEL_GROUP_NAME"  property="modelGroupName" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        RULE_ID, FOLDER_ID, RULE_NAME,RULE_DESC, RULE_TYPE, IS_DEL,IS_LOG,IS_HEADER, CREATE_PERSON, CREATE_DATE, UPDATE_PERSON,
        UPDATE_DATE, RULE_STATUS,DEPT_ID,DEPT_NAME,PARTNER_CODE,PARTNER_NAME,PRODUCT_CODE,PRODUCT_NAME ,SYSTEM_CODE ,SYSTEM_NAME,MODULE_NAME,CREATE_USER_JOB_NUMBER,UPDATE_USER_JOB_NUMBER
    </sql>

    <sql id="Version_Column_List">
        RULE_ID, FOLDER_ID, RULE_NAME,RULE_DESC, RULE_TYPE,IS_PUBLIC, IS_DEL,IS_LOG,IS_HEADER, CREATE_PERSON, CREATE_DATE, UPDATE_PERSON,
        UPDATE_DATE, MODEL_GROUP_ID, RULE_STATUS,DEPT_ID,DEPT_NAME,PARTNER_CODE,PARTNER_NAME,PRODUCT_CODE,PRODUCT_NAME ,SYSTEM_CODE ,SYSTEM_NAME,MODULE_NAME, CREATE_USER_JOB_NUMBER,UPDATE_USER_JOB_NUMBER, VERSION, VERSION_DESC, VERSION_CREATE_PERSON,
        VERSION_CREATE_DATE, VERSION_UPDATE_PERSON, VERSION_UPDATE_DATE
    </sql>
    <sql id="Version_Column_List_DRAFT">
        RULE_ID, FOLDER_ID, RULE_NAME,RULE_DESC, RULE_TYPE,IS_PUBLIC, IS_DEL,IS_LOG,IS_HEADER, CREATE_PERSON, CREATE_DATE, UPDATE_PERSON,
        UPDATE_DATE, MODEL_GROUP_ID, RULE_STATUS, DEPT_ID,DEPT_NAME,PARTNER_CODE,PARTNER_NAME,PRODUCT_CODE,PRODUCT_NAME ,SYSTEM_CODE ,SYSTEM_NAME ,MODULE_NAME,CREATE_USER_JOB_NUMBER,UPDATE_USER_JOB_NUMBER,VERSION ||'(草稿)' AS VERSION, VERSION_DESC, VERSION_CREATE_PERSON,
        VERSION_CREATE_DATE, VERSION_UPDATE_PERSON, VERSION_UPDATE_DATE
    </sql>

    <sql id="Blob_Column_List">
        RULE_CONTENT, RULE_INTERCEPT
    </sql>

    <select id="getModelByRuleSetId" parameterType="java.lang.String" resultMap="getModelByRuleSetIdList">
        SELECT
          a.RULE_ID,
          a.RULE_TYPE,
          a.RULE_NAME,
          a.VERSION,
          k.MODEL_GROUP_NAME
        FROM CRE_RULE_DETAIL a
        LEFT JOIN CRE_PUB_MODEL_GROUP k ON a.MODEL_GROUP_ID = k.MODEL_GROUP_ID
        LEFT JOIN CRE_PUB_RULE_SET_RULE b ON b.RULE_ID = a.RULE_ID
        WHERE b.RULE_SET_ID = #{ruleSetId,jdbcType=VARCHAR}
    </select>

    <select id="pagedByRuleNameFolderNameRuleType" resultType="com.bonc.frame.entity.auth.resource.RuleResource"
            parameterType="java.util.Map">
        SELECT
        a.RULE_ID AS "ruleId",
        a.FOLDER_ID AS "folderId",
        a.RULE_NAME AS "ruleName",
        a.MODULE_NAME AS "moduleName",
        a.RULE_TYPE AS "ruleType",
        b.FOLDER_NAME AS "folderName"
        FROM CRE_RULE_DETAIL a INNER JOIN CRE_RULE_FOLDER b
        ON a.FOLDER_ID = b.FOLDER_ID
        WHERE a.IS_DEL = '0' AND a.IS_PUBLIC = '0' AND IS_HEADER = '1'
        <if test="moduleName != null">
            AND a.MODULE_NAME = #{moduleName, jdbcType=VARCHAR}
        </if>
        <if test="ruleType != null">
            AND a.RULE_TYPE = #{ruleType, jdbcType=VARCHAR}
        </if>
        <if test="folderName != null">
            AND b.FOLDER_NAME = #{folderName, jdbcType=VARCHAR}
        </if>
        ORDER BY a.CREATE_DATE DESC
    </select>

    <select id="pagedBySubjectidAuthRuleNameFolderNameRuleType"
            resultType="com.bonc.frame.entity.auth.resource.RuleResource"
            parameterType="java.util.Map">
        SELECT
        *
        FROM
        (
        SELECT
        a.RULE_ID AS "ruleId",
        a.FOLDER_ID AS "folderId",
        a.RULE_NAME AS "ruleName",
        a.MODULE_NAME AS "moduleName",
        a.RULE_TYPE AS "ruleType",
        b.FOLDER_NAME AS "folderName"
        FROM CRE_RULE_DETAIL a INNER JOIN CRE_RULE_FOLDER b
        ON a.FOLDER_ID = b.FOLDER_ID
        WHERE a.IS_DEL = '0' AND a.IS_PUBLIC = '0' AND IS_HEADER = '0'
        <if test="moduleName != null">
            AND a.MODULE_NAME = #{moduleName, jdbcType=VARCHAR}
        </if>
        <if test="ruleType != null">
            AND a.RULE_TYPE = #{ruleType, jdbcType=VARCHAR}
        </if>
        <if test="folderName != null">
            AND b.FOLDER_NAME = #{folderName, jdbcType=VARCHAR}
        </if>
        ORDER BY a.CREATE_DATE DESC
        ) c INNER JOIN CRE_AUTH_AUTHORITY d
        ON c."ruleId" = d.RESOURCE_ID
        WHERE d.SUBJECT_ID IN
        <foreach collection="subjects" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Version_Column_List"/>
        from CRE_RULE_DETAIL
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
        AND IS_DEL = '0'
    </select>

    <select id="selectWithBlobByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String">
        select
        <include refid="Version_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from CRE_RULE_DETAIL
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
        and IS_DEL='0'
    </select>

    <select id="selectWithBlobByPrimaryKeyForDraft" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String">
        select
        <include refid="Version_Column_List_DRAFT"/>
        ,
        <include refid="Blob_Column_List"/>
        from CRE_RULE_DETAIL_DRAFT
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
        and IS_DEL='0'
    </select>
    <select id="selectWithBlobByProperty" resultMap="ResultMapWithBLOBs" parameterType="map">
        select
        <include refid="Version_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from CRE_RULE_DETAIL
        where IS_DEL='0'
        <if test="ruleName != null">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="ruleId != null">
            AND RULE_ID = #{ruleId,jdbcType=VARCHAR}
        </if>
        <if test="version != null">
            AND VERSION = #{version,jdbcType=VARCHAR}
        </if>
    </select>
    <select id="selectWithBlobByPropertyForDraft" resultMap="ResultMapWithBLOBs" parameterType="map">
        select
        <include refid="Version_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from CRE_RULE_DETAIL
        where IS_DEL='0'
        <if test="ruleName != null">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="ruleId != null">
            AND RULE_ID = #{ruleId,jdbcType=VARCHAR}
        </if>
        <if test="version != null">
            AND VERSION = #{version,jdbcType=VARCHAR}
        </if>
    </select>

    <select id="selectRuleDetailByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        from CRE_RULE_DETAIL
        where RULE_ID = #{ruleId,jdbcType=VARCHAR} AND IS_DEL = '0'
    </select>
    <select id="selectRuleDetailByPrimaryKeyForDraft" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        from CRE_RULE_DETAIL_DRAFT
        where RULE_ID = #{ruleId,jdbcType=VARCHAR} AND IS_DEL = '0'
    </select>

    <select id="selectEnableRuleDetail" resultMap="BaseResultMap" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        from CRE_RULE_DETAIL
        where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        AND IS_HEADER = '0'
        and IS_DEL = '0' and RULE_STATUS = '1' AND IS_DEL = '0'
    </select>

    <!-- 获取规则列表，不包含规则内容 -->
    <select id="selectRuleDetailByFolderIdOrRuleName" resultMap="BaseResultMap" parameterType="map">

        (SELECT
        <include refid="Version_Column_List"/>
        FROM
        CRE_RULE_DETAIL
        WHERE 1=1
        and FOLDER_ID = '0000000000000000000000000000001'
        <if test="folderId != null and '' != folderId">
            AND MODEL_GROUP_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        <if test="ruleName != null and '' != ruleName">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="isPublic != null and '' != ruleName">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        AND IS_DEL = '0'
        AND IS_HEADER = '0') UNION ALL
        ( SELECT
        a.*
        FROM
        ( select
        <include refid="Version_Column_List_DRAFT"/>
        from CRE_RULE_DETAIL_DRAFT
        WHERE 1=1
        <if test="folderId != null and '' != folderId">
        AND MODEL_GROUP_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        <if test="ruleName != null and '' != ruleName">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="isPublic != null and '' != ruleName">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        AND IS_DEL = '0' ) a
        JOIN ( SELECT
        RULE_NAME,
        max(VERSION_CREATE_DATE) as VERSION_CREATE_DATE
        FROM
        (
        SELECT
        FOLDER_ID,
        RULE_NAME,
        VERSION_CREATE_DATE
        FROM
        CRE_RULE_DETAIL_DRAFT
        WHERE 1=1
        <if test="folderId != null and '' != folderId">
        AND MODEL_GROUP_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        <if test="ruleName != null and '' != ruleName">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="isPublic != null and '' != ruleName">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        AND IS_DEL = '0'
        ) GROUP BY RULE_NAME ) b
        ON a.RULE_NAME = b.RULE_NAME where a.VERSION_CREATE_DATE = b.VERSION_CREATE_DATE )
        ORDER BY RULE_NAME
    </select>

    <!-- 获取规则列表，不包含规则内容 -->
    <select id="selectAllVersionRuleDetailByFolderIdOrRuleName" resultMap="BaseResultMap" parameterType="map">

        (SELECT
        <include refid="Version_Column_List"/>
        FROM
        CRE_RULE_DETAIL
        WHERE 1=1
        <if test="folderId != null and '' != folderId">
            AND FOLDER_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        <if test="ruleName != null and '' != ruleName">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="isPublic != null and '' != ruleName">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        AND IS_DEL = '0'
        AND IS_HEADER = '0')
        <if test="needDraft != null and needDraft == '1'.toString()">
            UNION ALL
            ( select
            <include refid="Version_Column_List_DRAFT"/>
            from CRE_RULE_DETAIL_DRAFT
            WHERE 1=1
            <if test="folderId != null and '' != folderId">
                AND FOLDER_ID = #{folderId,jdbcType=VARCHAR}
            </if>
            <if test="ruleName != null and '' != ruleName">
                AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
            </if>
            <if test="isPublic != null and '' != ruleName">
                AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
            </if>
            AND IS_DEL = '0')
        </if>
        ORDER BY VERSION ASC , VERSION_CREATE_DATE DESC
    </select>

    <!-- 获取规则列表，不包含规则内容 -->
    <select id="getRuleDetailWhthBOLOBListByFolderId" resultMap="ResultMapWithBLOBs" parameterType="map">
        SELECT
        <include refid="Version_Column_List"/>,
        <include refid="Blob_Column_List"/>
        FROM
        CRE_RULE_DETAIL
        WHERE
        FOLDER_ID = #{folderId,jdbcType=VARCHAR}
        AND IS_DEL = '0'
        AND IS_HEADER = '0'
        order by rule_name
    </select>

    <!-- 获取模型的版本列表 -->
    <select id="getVersionWithBLOBSList" parameterType="java.util.Map" resultMap="ResultMapWithBLOBs">
        SELECT
        <include refid="Version_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        FROM CRE_RULE_DETAIL
        WHERE
        IS_DEL = '0'
        AND IS_HEADER = '0'
        <if test="ruleName != null">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        ORDER BY RULE_NAME DESC
    </select>

    <!-- 获取所有的规则名称 -->
    <select id="selectRuleNameByFolder" resultType="map">
        SELECT RULE_ID       AS "ruleId",
               RULE_NAME     AS "ruleName",
               "MODULE_NAME" AS "moduleName"
        FROM CRE_RULE_DETAIL
        WHERE FOLDER_ID = #{folderId,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND IS_HEADER = '1'
    </select>
    
    <select id="selectModelList" parameterType="java.util.Map" resultType="map">
        SELECT a.RULE_ID       AS "ruleId",
               a.RULE_NAME     AS "ruleName",
               a.MODULE_NAME  AS "moduleName"
        FROM CRE_RULE_DETAIL a
        left join CRE_PUB_MODEL_GROUP_CHANNEL b on a.MODEL_GROUP_ID = b.MODEL_GROUP_ID
        WHERE a.FOLDER_ID = '0000000000000000000000000000001'
          AND a.IS_DEL = '0'
          AND a.IS_HEADER = '1'
         <if test="modelGroupId != null">
            and a.MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR}
        </if>
<!--        <if test="channelId != null">-->
<!--            and  b.CHANNEL_ID=#{channelId,jdbcType=VARCHAR}-->
<!--         </if>-->
    </select>

    <!-- 获取所有的规则名称 多版本改造 -->
    <select id="selectRuleNameInHeaderByFolder" resultType="map">
        SELECT MODULE_NAME AS "moduleName",
               RULE_NAME   AS "ruleName"
        FROM CRE_RULE_DETAIL
        WHERE FOLDER_ID = #{folderId,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND IS_HEADER = '1'
    </select>

    <!-- 获取规则列表，包含规则内容 -->
    <select id="selectBlobsByFolderId" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String">
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from CRE_RULE_DETAIL
        where FOLDER_ID = #{folderId,jdbcType=VARCHAR}
        AND IS_DEL = '0'
    </select>

    <!-- 查询规则名是否重复 -->
    <select id="getRuleCountByName" parameterType="map" resultType="int">
        select count(*) as "count"
        from CRE_RULE_DETAIL
        where MODULE_NAME = #{moduleName,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND IS_HEADER = '1'
    </select>


    <!-- 查询规则名在草稿箱是否重复 -->
    <select id="getRuleCountByNameForDraft" parameterType="map" resultType="int">
        select count(*) as "count" from CRE_RULE_DETAIL_DRAFT
        where MODULE_NAME = #{moduleName,jdbcType=VARCHAR}
        AND IS_DEL = '0' AND IS_HEADER = '1'
        <if test="ruleId != null">
            and RULE_ID != #{ruleId,jdbcType=VARCHAR}
        </if>
    </select>

    <!-- 查询规则名在草稿箱是否重复 -->
    <select id="isNeedDelHeader" parameterType="map" resultType="int">
        select COUNT(*)
        from (
                 select RULE_ID
                 from CRE_RULE_DETAIL
                 where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
                   AND IS_DEL = '0'
                   AND IS_HEADER = '0'
                   and RULE_ID != #{ruleId,jdbcType=VARCHAR}
                 UNION
                 select RULE_ID
                 from CRE_RULE_DETAIL_DRAFT
                 where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
                   AND IS_DEL = '0'
                   and RULE_ID != #{ruleId,jdbcType=VARCHAR}
             )

    </select>

    <!-- 查询文件夹中已启用规则数量 -->
    <select id="selectRunRuleCountByFolderId" parameterType="string" resultType="int">
        select count(*) as "count"
        from CRE_RULE_DETAIL
        where IS_DEL = '0'
          and RULE_STATUS = '1'
          AND IS_HEADER = '0'
          and FOLDER_ID = #{folderId,jdbcType=VARCHAR}
    </select>

    <insert id="insertSelective" parameterType="com.bonc.frame.entity.rule.RuleDetailWithBLOBs">
        insert into CRE_RULE_DETAIL
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="ruleId != null">
                RULE_ID,
            </if>
            <if test="folderId != null">
                FOLDER_ID,
            </if>
            <if test="ruleName != null">
                RULE_NAME,
            </if>
            <if test="moduleName != null">
                MODULE_NAME,
            </if>
            <if test="ruleDesc != null">
                RULE_DESC,
            </if>
            <if test="ruleType != null">
                RULE_TYPE,
            </if>
            <if test="deptId != null">
                DEPT_ID,
            </if>
            <if test="deptName != null">
                DEPT_NAME,
            </if>
            <if test="partnerCode != null">
                PARTNER_CODE,
            </if>
            <if test="partnerName != null">
                PARTNER_NAME,
            </if>
            <if test="productCode != null">
                PRODUCT_CODE,
            </if>
            <if test="productName != null">
                PRODUCT_NAME,
            </if>
            <if test="systemCode != null">
                SYSTEM_CODE,
            </if>
            <if test="systemName != null">
                SYSTEM_NAME,
            </if>
            <if test="platformCreateUserJobNumber != null">
                CREATE_USER_JOB_NUMBER,
            </if>
            <if test="platformUpdateUserJobNumber != null">
                UPDATE_USER_JOB_NUMBER,
            </if>
            <if test="isDel != null">
                IS_DEL,
            </if>
            <if test="isLog != null">
                IS_LOG,
            </if>
            <if test="createPerson != null">
                CREATE_PERSON,
            </if>
            <if test="createDate != null">
                CREATE_DATE,
            </if>
            <if test="updatePerson != null">
                UPDATE_PERSON,
            </if>
            <if test="updateDate != null">
                UPDATE_DATE,
            </if>
            <if test="ruleStatus != null">
                RULE_STATUS,
            </if>
            <if test="ruleContent != null">
                RULE_CONTENT,
            </if>
            <if test="ruleIntercept != null">
                RULE_INTERCEPT,
            </if>
            <if test="isPublic != null">
                IS_PUBLIC,
            </if>
            <if test="modelGroupId != null">
                MODEL_GROUP_ID,
            </if>
            <if test="version != null">
                VERSION,
            </if>
            <if test="versionDesc != null">
                VERSION_DESC,
            </if>
            <if test="versionCreatePerson != null">
                VERSION_CREATE_PERSON,
            </if>
            <if test="versionCreateDate != null">
                VERSION_CREATE_DATE,
            </if>
            <if test="isHeader != null">
                IS_HEADER,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="ruleId != null">
                #{ruleId,jdbcType=VARCHAR},
            </if>
            <if test="folderId != null">
                #{folderId,jdbcType=VARCHAR},
            </if>
            <if test="ruleName != null">
                #{ruleName,jdbcType=VARCHAR},
            </if>
            <if test="moduleName != null">
                #{moduleName,jdbcType=VARCHAR},
            </if>
            <if test="ruleDesc != null">
                #{ruleDesc,jdbcType=VARCHAR},
            </if>
            <if test="ruleType != null">
                #{ruleType,jdbcType=VARCHAR},
            </if>
            <if test="deptId != null">
                #{deptId,jdbcType=VARCHAR},
            </if>
            <if test="deptName != null">
                #{deptName,jdbcType=VARCHAR},
            </if>
            <if test="partnerCode != null">
                #{partnerCode,jdbcType=VARCHAR},
            </if>
            <if test="partnerName != null">
                #{partnerName,jdbcType=VARCHAR},
            </if>
            <if test="productCode != null">
                #{productCode,jdbcType=VARCHAR},
            </if>
            <if test="productName != null">
                #{productName,jdbcType=VARCHAR},
            </if>
            <if test="systemCode != null">
                #{systemCode,jdbcType=VARCHAR},
            </if>
            <if test="systemName != null">
                #{systemName,jdbcType=VARCHAR},
            </if>
            <if test="platformCreateUserJobNumber != null">
                #{platformCreateUserJobNumber,jdbcType=VARCHAR},
            </if>
            <if test="platformUpdateUserJobNumber != null">
                #{platformUpdateUserJobNumber,jdbcType=VARCHAR},
            </if>
            <if test="isDel != null">
                #{isDel,jdbcType=VARCHAR},
            </if>
            <if test="isLog != null">
                #{isLog,jdbcType=VARCHAR},
            </if>
            <if test="createPerson != null">
                #{createPerson,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updatePerson != null">
                #{updatePerson,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="ruleStatus != null">
                #{ruleStatus,jdbcType=VARCHAR},
            </if>
            <if test="ruleContent != null">
                #{ruleContent,jdbcType=CLOB},
            </if>
            <if test="ruleIntercept != null">
                #{ruleIntercept,jdbcType=CLOB},
            </if>
            <if test="isPublic != null">
                #{isPublic,jdbcType=VARCHAR},
            </if>
            <if test="modelGroupId != null">
                #{modelGroupId,jdbcType=VARCHAR},
            </if>
            <if test="version != null">
                #{version,jdbcType=VARCHAR},
            </if>
            <if test="versionDesc != null">
                #{versionDesc,jdbcType=VARCHAR},
            </if>
            <if test="versionCreatePerson != null">
                #{versionCreatePerson,jdbcType=VARCHAR},
            </if>
            <if test="versionCreateDate != null">
                #{versionCreateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="isHeader != null">
                #{isHeader,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>

    <insert id="insertSelectiveTemp" parameterType="com.bonc.frame.entity.rule.RuleDetailWithBLOBs">
        insert into A
        <trim prefix="(" suffix=")" suffixOverrides=",">
            RULE_ID,
            MODULE_NAME
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{ruleId,jdbcType=VARCHAR},
            #{moduleName,jdbcType=VARCHAR}
        </trim>
    </insert>

    <insert id="insertSelectiveForDraft" parameterType="com.bonc.frame.entity.rule.RuleDetailWithBLOBs">
        insert into CRE_RULE_DETAIL_DRAFT
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="ruleId != null">
                RULE_ID,
            </if>
            <if test="folderId != null">
                FOLDER_ID,
            </if>
            <if test="ruleName != null">
                RULE_NAME,
            </if>
            <if test="moduleName != null">
                MODULE_NAME,
            </if>
            <if test="ruleDesc != null">
                RULE_DESC,
            </if>
            <if test="ruleType != null">
                RULE_TYPE,
            </if>
            <if test="deptId != null">
                DEPT_ID,
            </if>
            <if test="deptName != null">
                DEPT_NAME,
            </if>
            <if test="partnerCode != null">
                PARTNER_CODE,
            </if>
            <if test="partnerName != null">
                PARTNER_NAME,
            </if>
            <if test="productCode != null">
                PRODUCT_CODE,
            </if>
            <if test="productName != null">
                PRODUCT_NAME,
            </if>
            <if test="systemCode != null">
                SYSTEM_CODE,
            </if>
            <if test="systemName != null">
                SYSTEM_NAME,
            </if>
            <if test="platformCreateUserJobNumber != null">
                CREATE_USER_JOB_NUMBER,
            </if>
            <if test="platformUpdateUserJobNumber != null">
                UPDATE_USER_JOB_NUMBER,
            </if>
            <if test="isDel != null">
                IS_DEL,
            </if>
            <if test="isLog != null">
                IS_LOG,
            </if>
            <if test="createPerson != null">
                CREATE_PERSON,
            </if>
            <if test="createDate != null">
                CREATE_DATE,
            </if>
            <if test="updatePerson != null">
                UPDATE_PERSON,
            </if>
            <if test="updateDate != null">
                UPDATE_DATE,
            </if>
            <if test="ruleStatus != null">
                RULE_STATUS,
            </if>
            <if test="ruleContent != null">
                RULE_CONTENT,
            </if>
            <if test="ruleIntercept != null">
                RULE_INTERCEPT,
            </if>
            <if test="isPublic != null">
                IS_PUBLIC,
            </if>
            <if test="modelGroupId != null">
                MODEL_GROUP_ID,
            </if>
            <if test="version != null">
                VERSION,
            </if>
            <if test="versionDesc != null">
                VERSION_DESC,
            </if>
            <if test="versionCreatePerson != null">
                VERSION_CREATE_PERSON,
            </if>
            <if test="versionCreateDate != null">
                VERSION_CREATE_DATE,
            </if>
            <if test="isHeader != null">
                IS_HEADER,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="ruleId != null">
                #{ruleId,jdbcType=VARCHAR},
            </if>
            <if test="folderId != null">
                #{folderId,jdbcType=VARCHAR},
            </if>
            <if test="ruleName != null">
                #{ruleName,jdbcType=VARCHAR},
            </if>
            <if test="moduleName != null">
                #{moduleName,jdbcType=VARCHAR},
            </if>
            <if test="ruleDesc != null">
                #{ruleDesc,jdbcType=VARCHAR},
            </if>
            <if test="ruleType != null">
                #{ruleType,jdbcType=VARCHAR},
            </if>
            <if test="deptId != null">
                #{deptId,jdbcType=VARCHAR},
            </if>
            <if test="deptName != null">
                #{deptName,jdbcType=VARCHAR},
            </if>
            <if test="partnerCode != null">
                #{partnerCode,jdbcType=VARCHAR},
            </if>
            <if test="partnerName != null">
                #{partnerName,jdbcType=VARCHAR},
            </if>
            <if test="productCode != null">
                #{productCode,jdbcType=VARCHAR},
            </if>
            <if test="productName != null">
                #{productName,jdbcType=VARCHAR},
            </if>
            <if test="systemCode != null">
                #{systemCode,jdbcType=VARCHAR},
            </if>
            <if test="systemName != null">
                #{systemName,jdbcType=VARCHAR},
            </if>
            <if test="platformCreateUserJobNumber != null">
                #{platformCreateUserJobNumber,jdbcType=VARCHAR},
            </if>
            <if test="platformUpdateUserJobNumber != null">
                #{platformUpdateUserJobNumber,jdbcType=VARCHAR},
            </if>
            <if test="isDel != null">
                #{isDel,jdbcType=VARCHAR},
            </if>
            <if test="isLog != null">
                #{isLog,jdbcType=VARCHAR},
            </if>
            <if test="createPerson != null">
                #{createPerson,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updatePerson != null">
                #{updatePerson,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="ruleStatus != null">
                #{ruleStatus,jdbcType=VARCHAR},
            </if>
            <if test="ruleContent != null">
                #{ruleContent,jdbcType=CLOB},
            </if>
            <if test="ruleIntercept != null">
                #{ruleIntercept,jdbcType=CLOB},
            </if>
            <if test="isPublic != null">
                #{isPublic,jdbcType=VARCHAR},
            </if>
            <if test="modelGroupId != null">
                #{modelGroupId,jdbcType=VARCHAR},
            </if>
            <if test="version != null">
                #{version,jdbcType=VARCHAR},
            </if>
            <if test="versionDesc != null">
                #{versionDesc,jdbcType=VARCHAR},
            </if>
            <if test="versionCreatePerson != null">
                #{versionCreatePerson,jdbcType=VARCHAR},
            </if>
            <if test="versionCreateDate != null">
                #{versionCreateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="isHeader != null">
                #{isHeader,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>

    <update id="updateByPrimaryKeyForPublish" parameterType="com.bonc.frame.entity.rule.RuleDetailWithBLOBs">
        update CRE_RULE_DETAIL
        <set>
            FOLDER_ID = #{folderId,jdbcType=VARCHAR},
            RULE_NAME = #{ruleName,jdbcType=VARCHAR},
            RULE_DESC = #{ruleDesc,jdbcType=VARCHAR},
            RULE_TYPE = #{ruleType,jdbcType=VARCHAR},
            DEPT_ID = #{deptId,jdbcType=VARCHAR},
            DEPT_NAME = #{deptName,jdbcType=VARCHAR},
            PARTNER_CODE = #{partnerCode,jdbcType=VARCHAR},
            PARTNER_NAME = #{partnerName,jdbcType=VARCHAR},
            PRODUCT_CODE = #{productCode,jdbcType=VARCHAR},
            PRODUCT_NAME = #{productName,jdbcType=VARCHAR},
            SYSTEM_CODE = #{systemCode,jdbcType=VARCHAR},
            SYSTEM_NAME = #{systemName,jdbcType=VARCHAR},
            CREATE_USER_JOB_NUMBER = #{platformCreateUserJobNumber,jdbcType=VARCHAR},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber,jdbcType=VARCHAR},
            IS_DEL = #{isDel,jdbcType=VARCHAR},
            IS_LOG = #{isLog,jdbcType=VARCHAR},
            CREATE_PERSON = #{createPerson,jdbcType=VARCHAR},
            CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
            <if test="updatePerson != null">
                UPDATE_PERSON = #{updatePerson,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR},
            RULE_CONTENT = #{ruleContent,jdbcType=CLOB},
            <if test="ruleIntercept != null">
                RULE_INTERCEPT = #{ruleIntercept,jdbcType=CLOB},
            </if>
            IS_PUBLIC = #{isPublic,jdbcType=VARCHAR},
            MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR},
            VERSION = #{version,jdbcType=VARCHAR},
            <if test="versionDesc != null">
                VERSION_DESC = #{versionDesc,jdbcType=VARCHAR},
            </if>
            <if test="versionCreatePerson != null">
                VERSION_CREATE_PERSON = #{versionCreatePerson,jdbcType=VARCHAR},
            </if>
            <if test="versionCreateDate != null">
                VERSION_CREATE_DATE = #{versionCreateDate,jdbcType=VARCHAR},
            </if>
            <if test="versionUpdatePerson != null">
                VERSION_UPDATE_PERSON = #{versionUpdatePerson,jdbcType=VARCHAR},
            </if>
            <if test="versionUpdateDate != null">
                VERSION_UPDATE_DATE = #{versionUpdateDate,jdbcType=VARCHAR},
            </if>
        </set>
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
    </update>

    <update id="updateByPrimaryKeySelective" parameterType="com.bonc.frame.entity.rule.RuleDetailWithBLOBs">
        update CRE_RULE_DETAIL
        <set>
            <if test="folderId != null">
                FOLDER_ID = #{folderId,jdbcType=VARCHAR},
            </if>
            <if test="ruleName != null">
                RULE_NAME = #{ruleName,jdbcType=VARCHAR},
            </if>
            <if test="ruleDesc != null">
                RULE_DESC = #{ruleDesc,jdbcType=VARCHAR},
            </if>
            <if test="ruleType != null">
                RULE_TYPE = #{ruleType,jdbcType=VARCHAR},
            </if>
            <if test="isDel != null">
                IS_DEL = #{isDel,jdbcType=VARCHAR},
            </if>
            <if test="isLog != null">
                IS_LOG = #{isLog,jdbcType=VARCHAR},
            </if>
            <if test="createPerson != null">
                CREATE_PERSON = #{createPerson,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                CREATE_DATE = #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updatePerson != null">
                UPDATE_PERSON = #{updatePerson,jdbcType=VARCHAR},
            </if>
            CREATE_USER_JOB_NUMBER= #{platformCreateUserJobNumber,jdbcType=VARCHAR},
            UPDATE_USER_JOB_NUMBER= #{platformUpdateUserJobNumber,jdbcType=VARCHAR},
            <if test="updateDate != null">
                UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="ruleStatus != null">
                RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR},
            </if>
            <if test="ruleContent != null">
                RULE_CONTENT = #{ruleContent,jdbcType=CLOB},
            </if>
            <if test="ruleIntercept != null">
                RULE_INTERCEPT = #{ruleIntercept,jdbcType=CLOB},
            </if>
            <if test="isPublic != null">
                IS_PUBLIC = #{isPublic,jdbcType=VARCHAR},
            </if>
            <if test="modelGroupId != null">
                MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR},
            </if>
            <if test="version != null">
                VERSION = #{version,jdbcType=VARCHAR},
            </if>
            <if test="versionDesc != null">
                VERSION_DESC = #{versionDesc,jdbcType=VARCHAR},
            </if>
            <if test="versionCreatePerson != null">
                VERSION_CREATE_PERSON = #{versionCreatePerson,jdbcType=VARCHAR},
            </if>
            <if test="versionCreateDate != null">
                VERSION_CREATE_DATE = #{versionCreateDate,jdbcType=VARCHAR},
            </if>
            <if test="versionUpdatePerson != null">
                VERSION_UPDATE_PERSON = #{versionUpdatePerson,jdbcType=VARCHAR},
            </if>
            <if test="versionUpdateDate != null">
                VERSION_UPDATE_DATE = #{versionUpdateDate,jdbcType=VARCHAR},
            </if>
        </set>
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
    </update>


    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        delete
        from CRE_RULE_DETAIL
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
    </delete>

    <!-- 根据文件夹中ID删除全部规则 -->
    <delete id="deleteRuleByFolderId" parameterType="string">
        delete
        from CRE_RULE_DETAIL
        where FOLDER_ID = #{folderId,jdbcType=VARCHAR}
    </delete>

    <!-- ======================= 模型库 ======================= -->

    <!-- 统计模型下启用状态的版本的数量 -->
    <select id="countEnableVersions" parameterType="java.lang.String" resultType="int">
        SELECT COUNT(1)
        FROM CRE_RULE_DETAIL
        WHERE RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND RULE_STATUS = '1'
          AND IS_HEADER = '0'
    </select>

    <!-- 统计新名称的个数 -->
    <select id="countModuleNameByOld" parameterType="map" resultType="int">
        select count(*) as "count"
        from CRE_RULE_DETAIL
        where MODULE_NAME = #{moduleName,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND IS_HEADER = '1'
          and MODULE_NAME != #{oldModuleName,jdbcType=VARCHAR}
    </select>

    <!-- 检验 version ruleName 联合唯一性 -->
    <select id="countByVersionAndHeaderId" parameterType="java.util.Map" resultType="int">
        select count(*) as "count" from CRE_RULE_DETAIL
        where VERSION = #{version,jdbcType=VARCHAR}
        AND IS_DEL = '0'
        AND IS_HEADER = '0'
        AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        <if test="ruleId != null">
            AND RULE_ID != #{ruleId,jdbcType=VARCHAR}
        </if>
    </select>

    <!-- 查看当前版本是否在启用中 -->
    <select id="checkEnable" parameterType="java.lang.String" resultType="int">
        SELECT COUNT(1)
        FROM CRE_RULE_DETAIL
        WHERE RULE_ID = #{ruleId,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND IS_HEADER = '0'
          AND RULE_STATUS = '1'
    </select>

    <!-- 查看当前版本是否在启用中 -->
    <select id="checkPreVersionEnable" parameterType="java.util.HashMap" resultType="int">
        SELECT COUNT(1)
        FROM CRE_RULE_DETAIL
        WHERE RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          AND IS_DEL = '0'
          AND IS_HEADER = '0'
          AND RULE_STATUS = '1'
          AND VERSION_CREATE_DATE &lt;= to_date(#{versionCreateDate,jdbcType=TIMESTAMP}, 'yyyy-mm-dd hh24:mi:ss')
    </select>

    <!-- 获取单个模型头信息 -->
    <select id="getOneHeader" parameterType="java.lang.String" resultMap="RuleDetailHeaderMap">
        SELECT RULE_NAME,
               FOLDER_ID,
               MODULE_NAME,
               RULE_DESC,
               RULE_TYPE,
               IS_PUBLIC,
               MODEL_GROUP_ID,
               CREATE_DATE,
               CREATE_PERSON,
               DEPT_ID,
               DEPT_NAME,
               PARTNER_CODE,
               PARTNER_NAME,
               PRODUCT_CODE,
               PRODUCT_NAME,
               SYSTEM_CODE,
               SYSTEM_NAME,
               CREATE_USER_JOB_NUMBER,
               UPDATE_USER_JOB_NUMBER
        FROM CRE_RULE_DETAIL
        WHERE IS_DEL = '0'
          AND IS_HEADER = '1'
          AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        ORDER BY CREATE_DATE DESC
    </select>

    <!-- 查询模型头信息列表 -->
    <select id="getHeaderList" parameterType="java.util.Map" resultMap="RuleDetailHeaderMap">
        SELECT a.*, b.MODEL_GROUP_NAME FROM (
        SELECT
        RULE_NAME,FOLDER_ID, RULE_DESC,RULE_TYPE,IS_PUBLIC,MODEL_GROUP_ID,CREATE_DATE,
        CREATE_PERSON,DEPT_ID,DEPT_NAME,PARTNER_CODE,PARTNER_NAME, PRODUCT_CODE,PRODUCT_NAME,
        SYSTEM_CODE,SYSTEM_NAME,MODULE_NAME,CREATE_USER_JOB_NUMBER,UPDATE_USER_JOB_NUMBER
        FROM
        CRE_RULE_DETAIL
        WHERE IS_DEL = '0'
        AND IS_HEADER = '1'
        <if test="isPublic != null">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        <if test="ruleName != null">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="moduleName != null">
            <bind name="pattern" value="'%' + _parameter.moduleName + '%'"/>
            AND MODULE_NAME like #{pattern}
        </if>
        <if test="folderId != null">
            AND FOLDER_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        <if test="modelGroupId != null">
            AND MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR}
        </if>
        <if test="ruleType != null">
            AND RULE_TYPE = #{ruleType,jdbcType=VARCHAR}
        </if>
        <if test="startDate != null and '' != startDate">
            and CREATE_DATE &gt;= to_date(#{startDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="endDate != null and '' != endDate">
            and CREATE_DATE &lt;= to_date(#{endDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="deptId != null and '' != deptId">
            AND DEPT_ID = #{deptId,jdbcType=VARCHAR}
        </if>
        <if test="deptName != null and '' != deptName">
            AND DEPT_NAME = #{deptName,jdbcType=VARCHAR}
        </if>
        <if test="partnerId != null and '' != partnerId">
            AND PARTNER_CODE = #{partnerId,jdbcType=VARCHAR}
        </if>
        <if test="partnerName != null and '' != partnerName">
            AND PARTNER_NAME = #{partnerName,jdbcType=VARCHAR}
        </if>
        <if test="productCode != null and '' != deptId">
            AND PRODUCT_CODE = #{productCode,jdbcType=VARCHAR}
        </if>
        <if test="productName != null and '' != deptName">
            AND PRODUCT_NAME = #{productName,jdbcType=VARCHAR}
        </if>
        <if test="systemCode != null and '' != partnerId">
            AND SYSTEM_CODE = #{systemCode,jdbcType=VARCHAR}
        </if>
        <if test="systemName != null and '' != partnerId">
            AND SYSTEM_NAME = #{systemName,jdbcType=VARCHAR}
        </if>
        <if test="platformCreateUserJobNumber != null and '' != platformCreateUserJobNumber">
            AND CREATE_USER_JOB_NUMBER = #{platformCreateUserJobNumber,jdbcType=VARCHAR}
        </if>
        <if test="platformUpdateUserJobNumber != null and '' != platformUpdateUserJobNumber">
            AND UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber,jdbcType=VARCHAR}
        </if>
        )
        a LEFT JOIN CRE_PUB_MODEL_GROUP b
        on a.MODEL_GROUP_ID = b.MODEL_GROUP_ID
        WHERE 1=1
        <if test="modelGroupName != null">
            <bind name="pattern2" value="'%' + _parameter.modelGroupName + '%'"/>
            AND MODEL_GROUP_NAME like #{pattern2}
        </if>
        ORDER BY a.CREATE_DATE DESC
    </select>

    <!-- 查询模型头信息列表 -->
    <select id="getModelHeaderListByProperty" parameterType="java.util.Map" resultMap="RuleDetailHeaderMap">
        SELECT
        RULE_NAME,FOLDER_ID, RULE_DESC,RULE_TYPE,IS_PUBLIC,MODEL_GROUP_ID,CREATE_DATE,
        CREATE_PERSON,DEPT_ID,DEPT_NAME,PARTNER_CODE,PARTNER_NAME, PRODUCT_CODE,PRODUCT_NAME,
        SYSTEM_CODE,SYSTEM_NAME,MODULE_NAME,CREATE_USER_JOB_NUMBER,UPDATE_USER_JOB_NUMBER
        FROM
        CRE_RULE_DETAIL
        WHERE IS_DEL = '0'
        AND IS_HEADER = '1'
        <if test="isPublic != null">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        <if test="ruleName != null">
            AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        </if>
        <if test="moduleName != null">
            AND MODULE_NAME = #{moduleName,jdbcType=VARCHAR}
        </if>
        <if test="folderId != null">
            AND FOLDER_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        <if test="modelGroupId != null">
            AND MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR}
        </if>
        ORDER BY CREATE_DATE DESC
    </select>

    <!-- 查询模型头信息列表  用于权限管理 -->
    <select id="getHeaderListResource" parameterType="java.util.Map"
            resultType="com.bonc.frame.entity.auth.resource.PubModelBaseResource">
        SELECT
        a.RULE_NAME as "ruleName" ,
        a.FOLDER_ID as "folderId" ,
        a.RULE_DESC as "ruleDesc" ,
        a.RULE_TYPE AS "ruleType" ,
        a.IS_PUBLIC AS "isPublic" ,
        a.IS_HEADER AS "isHeader",
        a.MODULE_NAME AS "moduleName",
        a.MODEL_GROUP_ID AS "modelGroupId" ,
        a.CREATE_DATE AS "createDate",
        a.CREATE_PERSON AS "createPerson",
        b.MODEL_GROUP_NAME AS "modelGroupName"
        FROM
        CRE_RULE_DETAIL a LEFT JOIN CRE_PUB_MODEL_GROUP b
        on a.MODEL_GROUP_ID = b.MODEL_GROUP_ID
        WHERE
        a.IS_PUBLIC = '1'
        AND a.IS_DEL = '0'
        AND a.IS_HEADER = '1'
        <if test="moduleName != null">
            <bind name="pattern" value="'%' + _parameter.moduleName + '%'"/>
            AND a.MODULE_NAME like #{pattern}
        </if>
        <if test="ruleType != null">
            AND a.RULE_TYPE = #{ruleType,jdbcType=VARCHAR}
        </if>
        <if test="startDate != null and '' != startDate">
            and a.CREATE_DATE &gt;= to_date(#{startDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="endDate != null and '' != endDate">
            and a.CREATE_DATE &lt;= to_date(#{endDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="modelGroupName != null">
            <bind name="pattern2" value="'%' + _parameter.modelGroupName + '%'"/>
            AND b.MODEL_GROUP_NAME like #{pattern2}
        </if>
        ORDER BY a.CREATE_DATE DESC
    </select>

    <!-- 获取模型的版本列表 -->
    <select id="getVersionIdsByRuleName" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT RULE_ID
        FROM CRE_RULE_DETAIL
        WHERE IS_DEL = '0'
          AND IS_HEADER = '0'
          AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
    </select>

    <!-- 获取启用的模型的版本列表 用于离线任务 -->
    <select id="getEnableVersionBaseInfoByRuleName" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT RULE_ID,
               VERSION
        FROM CRE_RULE_DETAIL
        WHERE IS_DEL = '0'
          AND IS_HEADER = '0'
          AND RULE_STATUS = '1'
          AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
    </select>

    <!-- 获取模型的版本列表 -->
    <select id="getVersionList" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        <include refid="Version_Column_List"/>
        FROM CRE_RULE_DETAIL
        WHERE
        IS_PUBLIC = '1'
        AND IS_DEL = '0'
        AND IS_HEADER = '0'
        AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        <if test="ruleStatus != null and ruleStatus.toString() eq '1'.toString()">
            AND RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR}
        </if>
        <if test="ruleStatus != null and ruleStatus.toString() neq '1'.toString()">
            AND RULE_STATUS != '1'
        </if>
        <if test="isLog != null">
            AND IS_LOG = #{isLog,jdbcType=VARCHAR}
        </if>
        <if test="startDate != null and '' != startDate">
            and VERSION_CREATE_DATE &gt;= to_date(#{startDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="endDate != null and '' != endDate">
            and VERSION_CREATE_DATE &lt;= to_date(#{endDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        ORDER BY to_number(VERSION) DESC ,VERSION_CREATE_DATE DESC
    </select>
    <!-- 用来修改模型的头信息（同一版本间共有的字段）-->
    <update id="updateByRuleNameSelective" parameterType="com.bonc.frame.entity.rule.RuleDetailHeader">
        update CRE_RULE_DETAIL
        <set>
            <if test="moduleName != null and '' != moduleName">
                MODULE_NAME = #{moduleName,jdbcType=VARCHAR},
            </if>
            <if test="ruleDesc != null and '' != ruleDesc">
                RULE_DESC = #{ruleDesc,jdbcType=VARCHAR},
            </if>
            <if test="ruleType != null and '' != ruleType">
                RULE_TYPE = #{ruleType,jdbcType=VARCHAR},
            </if>
            <if test="updatePerson != null and '' != updatePerson">
                UPDATE_PERSON = #{updatePerson,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="modelGroupId != null and '' != modelGroupId">
                MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR},
            </if>
            <if test="deptId != null and '' != deptId">
                DEPT_ID = #{deptId,jdbcType=VARCHAR},
            </if>
            <if test="deptName != null and '' != deptName">
                DEPT_NAME = #{deptName,jdbcType=VARCHAR},
            </if>
            <if test="partnerCode != null and '' != partnerCode">
                PARTNER_CODE = #{partnerCode,jdbcType=VARCHAR},
            </if>
            <if test="partnerName != null and '' != partnerName">
                PARTNER_NAME = #{partnerName,jdbcType=VARCHAR},
            </if>
            <if test="productCode != null and '' != productCode">
                PRODUCT_CODE = #{productCode,jdbcType=VARCHAR},
            </if>
            <if test="productName != null and '' != productName">
                PRODUCT_NAME = #{productName,jdbcType=VARCHAR},
            </if>
            <if test="systemCode != null and '' != systemCode">
                SYSTEM_CODE = #{systemCode,jdbcType=VARCHAR},
            </if>
            <if test="systemName != null and '' != systemName">
                SYSTEM_NAME = #{systemName,jdbcType=VARCHAR},
            </if>
            <if test="platformUpdateUserJobNumber != null  and '' != platformUpdateUserJobNumber">
                UPDATE_USER_JOB_NUMBER= #{platformUpdateUserJobNumber,jdbcType=VARCHAR}
            </if>
        </set>
        where RULE_NAME = #{oldRuleName,jdbcType=VARCHAR}
    </update>

    <update id="updateByRuleNameSelectiveForDraft" parameterType="com.bonc.frame.entity.rule.RuleDetailHeader">
        update CRE_RULE_DETAIL_DRAFT
        <set>
            <if test="moduleName != null and '' != moduleName">
                MODULE_NAME = #{moduleName,jdbcType=VARCHAR},
            </if>
            <if test="ruleDesc != null and '' != ruleDesc">
                RULE_DESC = #{ruleDesc,jdbcType=VARCHAR},
            </if>
            <if test="ruleType != null and '' != ruleType">
                RULE_TYPE = #{ruleType,jdbcType=VARCHAR},
            </if>
            <if test="updatePerson != null and '' != updatePerson">
                UPDATE_PERSON = #{updatePerson,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                UPDATE_DATE = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="modelGroupId != null and '' != modelGroupId">
                MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR},
            </if>
            <if test="deptId != null and '' != deptId">
                DEPT_ID = #{deptId,jdbcType=VARCHAR},
            </if>
            <if test="deptName != null and '' != deptName">
                DEPT_NAME = #{deptName,jdbcType=VARCHAR},
            </if>
            <if test="partnerCode != null and '' != partnerCode">
                PARTNER_CODE = #{partnerCode,jdbcType=VARCHAR},
            </if>
            <if test="partnerName != null and '' != partnerName">
                PARTNER_NAME = #{partnerName,jdbcType=VARCHAR},
            </if>
            <if test="productCode != null and '' != productCode">
                PRODUCT_CODE = #{productCode,jdbcType=VARCHAR},
            </if>
            <if test="productName != null and '' != productName">
                PRODUCT_NAME = #{productName,jdbcType=VARCHAR},
            </if>
            <if test="systemCode != null and '' != systemCode">
                SYSTEM_CODE = #{systemCode,jdbcType=VARCHAR},
            </if>
            <if test="systemName != null and '' != systemName">
                SYSTEM_NAME = #{systemName,jdbcType=VARCHAR},
            </if>
            <if test="platformUpdateUserJobNumber != null and '' != platformUpdateUserJobNumber">
                UPDATE_USER_JOB_NUMBER= #{platformUpdateUserJobNumber,jdbcType=VARCHAR}
            </if>
        </set>
        where RULE_NAME = #{oldRuleName,jdbcType=VARCHAR}
    </update>

    <!-- 删除模型及其下所有版本 -->
    <update id="deleteByRuleName" parameterType="java.util.Map">
        update CRE_RULE_DETAIL
        set IS_DEL                 = '1',
            UPDATE_PERSON          = #{updatePerson,jdbcType=VARCHAR},
            UPDATE_DATE            = #{updateDate,jdbcType=TIMESTAMP},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber ,jdbcType=VARCHAR},
            VERSION_UPDATE_DATE    = sysdate
        where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          and IS_HEADER = '1'
    </update>

    <update id="deleteForSingleRule" parameterType="java.util.Map">
        update CRE_RULE_DETAIL
        set IS_DEL                 = '1',
            UPDATE_PERSON          = #{updatePerson,jdbcType=VARCHAR},
            UPDATE_DATE            = #{updateDate,jdbcType=TIMESTAMP},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber ,jdbcType=VARCHAR},
            VERSION_UPDATE_DATE    = sysdate
        where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
    </update>
    <update id="deleteForSingleRuleForDraft" parameterType="java.util.Map">
        update CRE_RULE_DETAIL_DRAFT
        set IS_DEL                 = '1',
            UPDATE_PERSON          = #{updatePerson,jdbcType=VARCHAR},
            UPDATE_DATE            = #{updateDate,jdbcType=TIMESTAMP},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber ,jdbcType=VARCHAR},
            VERSION_UPDATE_DATE    = sysdate
        where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
    </update>

    <update id="deleteDraftByRuld" parameterType="java.util.Map">
        update CRE_RULE_DETAIL_DRAFT
        set IS_DEL                 = '1',
            UPDATE_PERSON          = #{updatePerson,jdbcType=VARCHAR},
            UPDATE_DATE            = #{updateDate,jdbcType=TIMESTAMP},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber ,jdbcType=VARCHAR},
            VERSION_UPDATE_DATE    = sysdate
        where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          and VERSION = #{version,jdbcType=VARCHAR}
    </update>

    <delete id="deleteByRuleNameAndVersionForDraft" parameterType="java.util.Map">
        delete
        from CRE_RULE_DETAIL_DRAFT
        where RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          and VERSION = #{version,jdbcType=VARCHAR}
    </delete>

    <!-- 获取版本号-->
    <select id="getMaxVersion" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        <include refid="Version_Column_List"/>
        <if test="isDraft != 1">
            FROM CRE_RULE_DETAIL
        </if>
        <if test="isDraft == 1">
            FROM CRE_RULE_DETAIL_DRAFT
        </if>
        WHERE
        RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        AND IS_HEADER='0'
        AND IS_DEL='0'
        ORDER BY to_number(VERSION) DESC ,VERSION_CREATE_DATE DESC
    </select>

    <!-- 修改指定规则指定的其它版本为未状态 -->
    <update id="updateStatusToNotBegin" parameterType="java.util.Map">
        update CRE_RULE_DETAIL
        SET RULE_STATUS            = '2',
            UPDATE_PERSON          = #{updatePerson,jdbcType=VARCHAR},
            UPDATE_DATE            = #{updateDate,jdbcType=TIMESTAMP},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber ,jdbcType=VARCHAR}
        where RULE_ID != #{ruleId,jdbcType=VARCHAR}
          AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          AND IS_HEADER = '0'
          and IS_DEL = '0'
          and RULE_STATUS = '1'
    </update>
    <!-- 修改指定规则为执行中状态 -->
    <update id="updateStatusToExecution" parameterType="map">
        update CRE_RULE_DETAIL
        SET RULE_STATUS            = '1',
            UPDATE_PERSON          = #{updatePerson,jdbcType=VARCHAR},
            UPDATE_DATE            = #{updateDate,jdbcType=TIMESTAMP},
            UPDATE_USER_JOB_NUMBER = #{platformUpdateUserJobNumber ,jdbcType=VARCHAR}
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
          AND IS_HEADER = '0'
          and IS_DEL = '0'
    </update>


    <select id="getVersionList2" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        <include refid="Version_Column_List"/>
        <if test="isDraft == 0">
            FROM CRE_RULE_DETAIL
        </if>
        <if test="isDraft == 1">
            FROM CRE_RULE_DETAIL_DRAFT
        </if>
        WHERE
        IS_DEL = '0'
        AND IS_HEADER = '0'
        AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        <if test="isPublic != null and '' != isPublic">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        <if test="ruleStatus != null and '' != ruleStatus">
            AND RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR}
        </if>
        <if test="startDate != null and '' != startDate">
            and VERSION_CREATE_DATE &gt;= to_date(#{startDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="endDate != null and '' != endDate">
            and VERSION_CREATE_DATE &lt;= to_date(#{endDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        ORDER BY to_number(VERSION) DESC ,VERSION_CREATE_DATE DESC
    </select>

    <select id="getVersionList3" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        <include refid="Version_Column_List"/>
        <if test="isDraft == 0">
            FROM CRE_RULE_DETAIL
        </if>
        <if test="isDraft == 1">
            FROM CRE_RULE_DETAIL_DRAFT
        </if>
        WHERE
        IS_DEL = '0'
        AND IS_HEADER = '0'
        AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        AND RULE_STATUS != '1'
        <if test="isPublic != null and '' != isPublic">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        ORDER BY to_number(VERSION) DESC ,VERSION_CREATE_DATE DESC
    </select>

    <select id="getNewestForDraft" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        t.*
        FROM
        (SELECT
        <include refid="Version_Column_List_DRAFT"/>
        FROM CRE_RULE_DETAIL_DRAFT
        WHERE
        IS_DEL = '0'
        AND IS_HEADER = '0'
        AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        <if test="ruleStatus != null and '' != ruleStatus">
            AND RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR}
        </if>
        ORDER BY VERSION DESC ,VERSION_CREATE_DATE DESC
        ) t where rownum=1
    </select>

    <select id="getVersionList2Union" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        t.*
        FROM
        (SELECT
        <include refid="Version_Column_List"/>
        FROM CRE_RULE_DETAIL
        WHERE
        IS_DEL = '0'
        AND IS_HEADER = '0'
        AND RULE_NAME = #{ruleName,jdbcType=VARCHAR}
        <if test="isPublic != null and '' != isPublic">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        <if test="ruleStatus != null and '' != ruleStatus">
            AND RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR}
        </if>
        <if test="startDate != null and '' != startDate">
            and VERSION_CREATE_DATE &gt;= to_date(#{startDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        <if test="endDate != null and '' != endDate">
            and VERSION_CREATE_DATE &lt;= to_date(#{endDate,jdbcType=TIMESTAMP} ,'yyyy-mm-dd hh24:mi:ss')
        </if>
        UNION
        SELECT
        <include refid="Version_Column_List_DRAFT"/>
        FROM CRE_RULE_DETAIL_DRAFT
        where RULE_ID = #{ruleId,jdbcType=VARCHAR}
        <if test="isPublic != null and '' != isPublic">
            AND IS_PUBLIC = #{isPublic,jdbcType=VARCHAR}
        </if>
        <if test="ruleStatus != null and '' != ruleStatus">
            AND RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR}
        </if>
        ) t
        ORDER BY t.VERSION DESC ,t.VERSION_CREATE_DATE DESC
    </select>

    <!-- 根据模型名称、产品名称、模型类型、场景id查询 -->
    <select id="getModelByProduct" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT A.MODULE_NAME AS "moduleName", A.RULE_NAME AS "ruleName"
        FROM CRE_RULE_DETAIL A
        WHERE A.IS_DEL = '0' AND A.IS_HEADER = '1'
        <if test="moduleName != null">
            <bind name="pattern1" value="'%' + _parameter.moduleName + '%'"/>
            AND A.MODULE_NAME like #{pattern1}
        </if>
        <if test="productCode != null">
            AND A.PRODUCT_CODE = #{productCode,jdbcType=VARCHAR}
        </if>
        <if test="productName != null">
            AND A.PRODUCT_NAME = #{productName,jdbcType=VARCHAR}
        </if>
        <if test="folderId != null">
            AND A.FOLDER_ID = #{folderId,jdbcType=VARCHAR}
        </if>
        AND A.RULE_TYPE = #{ruleType,jdbcType=VARCHAR}
    </select>

    <!-- 根据模型id、模型状态查询 -->
    <select id="getVersionListByStatus" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT A.MODULE_NAME AS "moduleName", A.RULE_ID AS "ruleId", A.VERSION AS "version"
        FROM CRE_RULE_DETAIL A
        WHERE A.IS_DEL = '0'
          AND A.IS_HEADER = '0'
          AND A.RULE_NAME = #{ruleName,jdbcType=VARCHAR}
          AND A.RULE_STATUS = #{ruleStatus,jdbcType=VARCHAR}
    </select>

    <update id="groupAddModel" parameterType="map">
        update CRE_RULE_DETAIL
        set MODEL_GROUP_ID = #{modelGroupId,jdbcType=VARCHAR},IS_PUBLIC = '0'
        where RULE_NAME = #{ruleId,jdbcType=VARCHAR}
    </update>

</mapper>